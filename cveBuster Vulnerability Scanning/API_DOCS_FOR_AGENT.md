# cveBuster Vulnerability Scanning API Documentation
## For Microsoft Sentinel Codeless Connector Framework (CCF) Integration

---

## ðŸŽ¯ Quick Start for Connector Builders

**API Type:** REST API with cursor-based pagination and time-window filtering  
**Base URL:** `http://cvebuster.eastus.cloudapp.azure.com:5000/api`  
**Authentication:** API Key in `Authorization` header (no prefix, direct key value)  
**Default API Key:** `cvebuster-demo-key-12345`  
**Polling Pattern:** 5-minute incremental sync using time-window filtering

---

## ðŸ“‹ Microsoft Sentinel CCF Connector Requirements

### Resource Structure Required
```json
[
  {
    "name": "cveBusterVulnerabilitiesPoller",
    "apiVersion": "2022-10-01-preview",
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "kind": "RestApiPoller",
    "properties": {
      "connectorDefinitionName": "cveBusterVulnerabilitiesConnector",
      "dcrConfig": { ... },
      "auth": { ... },
      "request": { ... },
      "paging": { ... },
      "response": { ... }
    }
  }
]
```

**âš ï¸ CRITICAL:** Polling config MUST be wrapped in an array with full ARM resource structure including `name`, `apiVersion`, `type`, and `kind` properties.

---

## ðŸ” Authentication

### Method
**API Key Authentication** - Pass the API key directly in the `Authorization` header

### Header Format
```
Authorization: cvebuster-demo-key-12345
```

**Note:** Do NOT use "Bearer" prefix or "Basic" authentication scheme. The API accepts the raw API key value.

### CCF Configuration
```json
"auth": {
  "type": "APIKey",
  "ApiKey": "[[parameters('apiKey')]",
  "ApiKeyName": "Authorization"
}
```

### Authentication Testing
```bash
# âœ… CORRECT
curl -H "Authorization: cvebuster-demo-key-12345" \
  http://cvebuster.eastus.cloudapp.azure.com:5000/api/vulnerabilities

# âŒ WRONG - Don't use Bearer prefix
curl -H "Authorization: Bearer cvebuster-demo-key-12345" \
  http://cvebuster.eastus.cloudapp.azure.com:5000/api/vulnerabilities
```

---

## ðŸ”— Endpoint

### GET /api/vulnerabilities

Retrieves vulnerability scan data with pagination and time-based filtering.

**Full URL:** `http://cvebuster.eastus.cloudapp.azure.com:5000/api/vulnerabilities`

**Method:** `GET`

**Authentication:** Required (API Key)

---

## ðŸ“Š Response Structure

### Success Response (HTTP 200)

```json
{
  "vulnerabilities": [
    {
      "MachineName": "LoadBalancer01",
      "HostId": "5cf068c7-a2f5-4c14-b8f1-71c1d653bc8c",
      "IPAddress": "10.0.4.228",
      "OSFamily": "Ubuntu 18.04",
      "Application": "Docker",
      "AppFilePath": "/usr/bin/docker",
      "VulnId": "CVE-2021-26855",
      "VulnTitle": "Microsoft Exchange Server RCE",
      "Severity": "Critical",
      "CVSS": 9.0,
      "ExploitAvailable": true,
      "ExploitedInWild": true,
      "PatchAvailable": true,
      "FirstSeen": "2025-08-15T19:37:20Z",
      "LastSeen": "2025-10-26T19:37:20Z",
      "LastScanTime": "2025-11-06T19:37:20Z",
      "LastModified": "2025-08-25T19:37:20Z",
      "AssetCriticality": "High",
      "BusinessOwner": "Platform-Team",
      "Source": "cveBuster:demo"
    }
  ],
  "next_token": "NTA=",
  "total_filtered": 505,
  "page_size": 50,
  "offset": 0
}
```

### Response Fields

| Field | Type | Description |
|-------|------|-------------|
| `vulnerabilities` | array | Array of vulnerability objects (see Data Schema below) |
| `next_token` | string or null | Base64-encoded pagination token. `null` when no more pages exist. |
| `total_filtered` | integer | Total number of records matching the time filter (across all pages) |
| `page_size` | integer | Number of records returned in this response |
| `offset` | integer | Zero-based offset of the first record in this page |

### CCF Response Configuration
```json
"response": {
  "eventsJsonPaths": [
    "$.vulnerabilities"
  ]
}
```

**âš ï¸ CRITICAL:** The vulnerability records are in the `vulnerabilities` array, NOT `data`. Use JSONPath `$.vulnerabilities` to extract events.

---

## ðŸ“¦ Data Schema

### Vulnerability Object

Each vulnerability object contains **20 fields** representing a detected vulnerability on a scanned asset:

| Field Name | Data Type | Required | Description | Example |
|------------|-----------|----------|-------------|---------|
| `MachineName` | string | Yes | Hostname of the scanned asset | `ProdServer03` |
| `HostId` | string | Yes | Unique host identifier (UUID format) | `5e297337-1e4b-4115-8610-df6d2842ef50` |
| `IPAddress` | string | Yes | IPv4 address of the asset | `172.16.2.128` |
| `OSFamily` | string | Yes | Operating system name and version | `Ubuntu 18.04`, `Windows Server 2019` |
| `Application` | string | Yes | Name of vulnerable application | `Grafana`, `Apache`, `Docker` |
| `AppFilePath` | string | Yes | File system path of the application | `/usr/share/grafana` |
| `VulnId` | string | Yes | CVE identifier | `CVE-2021-3156` |
| `VulnTitle` | string | Yes | Human-readable vulnerability name | `Sudo Baron Samedit` |
| `Severity` | string | Yes | Severity level: `Critical`, `High`, `Medium`, `Low` | `High` |
| `CVSS` | real/float | Yes | CVSS v3.1 score (0.0 - 10.0) | `7.8` |
| `ExploitAvailable` | boolean | Yes | Whether public exploits exist | `true` |
| `ExploitedInWild` | boolean | Yes | Whether active exploitation detected | `false` |
| `PatchAvailable` | boolean | Yes | Whether vendor patch is available | `true` |
| `FirstSeen` | datetime (ISO 8601) | Yes | First detection timestamp | `2025-09-20T19:37:20Z` |
| `LastSeen` | datetime (ISO 8601) | Yes | Most recent detection timestamp | `2025-10-18T19:37:20Z` |
| `LastScanTime` | datetime (ISO 8601) | Yes | Most recent scan timestamp | `2025-11-06T19:37:20Z` |
| `LastModified` | datetime (ISO 8601) | Yes | **Record modification timestamp (used for time filtering)** | `2025-08-22T19:37:20Z` |
| `AssetCriticality` | string | Yes | Business criticality: `Critical`, `High`, `Medium`, `Low` | `Critical` |
| `BusinessOwner` | string | Yes | Owning team or department | `Database-Team` |
| `Source` | string | Yes | Data source identifier | `cveBuster:demo` |

### Log Analytics Table Schema

**Table Name:** `cveBusterVulnerabilities_CL` (note the underscore, not hyphen)

**Structure:** CCF Connector requires wrapping in an array with ARM resource properties:

```json
[
  {
    "name": "cveBusterVulnerabilities_CL",
    "apiVersion": "2021-03-01-privatepreview",
    "type": "Microsoft.OperationalInsights/workspaces/tables",
    "properties": {
      "schema": {
        "name": "cveBusterVulnerabilities_CL",
        "tableType": "CustomLog",
        "description": "cveBuster vulnerability scan data",
        "columns": [
          {
            "name": "TimeGenerated",
            "type": "datetime",
            "isDefaultDisplay": true,
            "description": "Ingestion timestamp"
          },
          {
            "name": "MachineName",
            "type": "string",
            "isDefaultDisplay": true,
            "description": "Hostname of the scanned machine"
          },
          ... (include all 20 fields)
        ]
      }
    }
  }
]
```

**âš ï¸ CRITICAL:** Table definition MUST be wrapped in an array with full ARM resource structure.

---

## ðŸ”„ Pagination

### Pagination Type
**Cursor-Based (NextPageToken)** - Uses base64-encoded offset tokens

### How It Works
1. Initial request returns first page + `next_token`
2. Include `next_token` in subsequent requests as a query parameter
3. Continue until `next_token` is `null`

### CCF Pagination Configuration
```json
"paging": {
  "pagingType": "NextPageToken",
  "nextPageTokenJsonPath": "$.next_token",
  "NextPageParaName": "next_token",
  "PageSize": "50",
  "PageSizeParameterName": "page_size"
}
```

**âš ï¸ CRITICAL Configuration Notes:**
- `pagingType` MUST be `"NextPageToken"` (not `"LinkHeader"`)
- `PageSize` value MUST be a string: `"50"` (not integer `50`)
- Token is passed as query parameter: `?next_token=NTA=`

### Query Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `page_size` | integer | No | Records per page. Default: `50`. Max: `1000`. Recommended: `50` |
| `next_token` | string | No | Base64-encoded pagination token from previous response |

### Pagination Example Flow

**Request 1:**
```
GET /api/vulnerabilities?page_size=50
```

**Response 1:**
```json
{
  "vulnerabilities": [...50 records...],
  "next_token": "NTA=",
  "total_filtered": 150,
  "page_size": 50,
  "offset": 0
}
```

**Request 2:**
```
GET /api/vulnerabilities?page_size=50&next_token=NTA=
```

**Response 2:**
```json
{
  "vulnerabilities": [...50 records...],
  "next_token": "MTAw",
  "total_filtered": 150,
  "page_size": 50,
  "offset": 50
}
```

**Request 3:**
```
GET /api/vulnerabilities?page_size=50&next_token=MTAw
```

**Response 3 (Final Page):**
```json
{
  "vulnerabilities": [...50 records...],
  "next_token": null,
  "total_filtered": 150,
  "page_size": 50,
  "offset": 100
}
```

---

## â° Time-Based Filtering (Incremental Sync)

### Purpose
Retrieve only records modified within a specific time window. Essential for CCF 5-minute polling pattern.

### Filter Field
**`LastModified`** - The API filters records based on this timestamp field in each vulnerability object.

### Query Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `createdAt__gt` | ISO 8601 datetime | No | Return records where `LastModified` > this timestamp (greater than) |
| `createdAt__lt` | ISO 8601 datetime | No | Return records where `LastModified` < this timestamp (less than) |

**Note:** Parameter names use double underscore: `createdAt__gt` and `createdAt__lt`

### Datetime Format
**ISO 8601 with UTC timezone:**
```
YYYY-MM-DDTHH:MM:SSZ
```

Example: `2025-11-06T10:00:00Z`

### CCF Request Configuration
```json
"request": {
  "apiEndpoint": "[[parameters('apiEndpoint')]",
  "rateLimitQPS": 10,
  "queryWindowInMin": 5,
  "httpMethod": "GET",
  "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
  "startTimeAttributeName": "createdAt__gt",
  "endTimeAttributeName": "createdAt__lt",
  "retryCount": 3,
  "timeoutInSeconds": 60,
  "headers": {
    "Accept": "application/json",
    "User-Agent": "cveBuster"
  }
}
```

**âš ï¸ CRITICAL Configuration Notes:**
- `queryWindowInMin`: `5` - Polls every 5 minutes
- `queryTimeFormat`: `"yyyy-MM-ddTHH:mm:ssZ"` - ISO 8601 format
- `startTimeAttributeName`: `"createdAt__gt"` - Parameter name for start time
- `endTimeAttributeName`: `"createdAt__lt"` - Parameter name for end time

### Time Filtering Example

**Scenario:** CCF poller runs every 5 minutes

**Request (10:00 AM - 10:05 AM window):**
```
GET /api/vulnerabilities?createdAt__gt=2025-11-06T10:00:00Z&createdAt__lt=2025-11-06T10:05:00Z&page_size=50
```

**Response:**
```json
{
  "vulnerabilities": [
    {
      "VulnId": "CVE-2024-12345",
      "LastModified": "2025-11-06T10:02:30Z",
      ...
    },
    {
      "VulnId": "CVE-2024-12346",
      "LastModified": "2025-11-06T10:04:15Z",
      ...
    }
  ],
  "next_token": null,
  "total_filtered": 2,
  "page_size": 50,
  "offset": 0
}
```

### Combined Pagination + Time Filtering

When combining pagination with time filtering, CCF automatically handles pagination within each 5-minute window:

**Request 1 (First page of 10:00-10:05 window):**
```
GET /api/vulnerabilities?createdAt__gt=2025-11-06T10:00:00Z&createdAt__lt=2025-11-06T10:05:00Z&page_size=50
```

**Request 2 (Next page if needed):**
```
GET /api/vulnerabilities?createdAt__gt=2025-11-06T10:00:00Z&createdAt__lt=2025-11-06T10:05:00Z&page_size=50&next_token=NTA=
```

---

## ðŸ“¡ Data Collection Rule (DCR)

### DCR Structure for CCF

**File Name:** `dataCollectionRule.json` or `cveBuster_DCR.json`

**Structure:** Array containing ARM resource definition

```json
[
  {
    "name": "cveBusterVulnerabilitiesDCR",
    "location": "[parameters('workspace-location')]",
    "apiVersion": "2021-09-01-preview",
    "type": "Microsoft.Insights/dataCollectionRules",
    "properties": {
      "dataCollectionEndpointId": "{{dataCollectionEndpointId}}",
      "streamDeclarations": {
        "Custom-cveBusterVulnerabilitiesStream": {
          "columns": [
            ... (all 20 fields except TimeGenerated)
          ]
        }
      },
      "destinations": {
        "logAnalytics": [
          {
            "workspaceResourceId": "{{workspaceResourceId}}",
            "name": "clv2ws1"
          }
        ]
      },
      "dataFlows": [
        {
          "streams": ["Custom-cveBusterVulnerabilitiesStream"],
          "destinations": ["clv2ws1"],
          "transformKql": "source | extend TimeGenerated = now()",
          "outputStream": "Custom-cveBusterVulnerabilities_CL"
        }
      ]
    }
  }
]
```

**âš ï¸ CRITICAL Configuration Notes:**
- Stream name: `Custom-cveBusterVulnerabilitiesStream`
- Output stream: `Custom-cveBusterVulnerabilities_CL`
- KQL transform adds `TimeGenerated` field: `source | extend TimeGenerated = now()`
- Stream declaration includes all fields EXCEPT `TimeGenerated` (added by transform)

### DCR Configuration in Polling Config

```json
"dcrConfig": {
  "streamName": "Custom-cveBusterVulnerabilitiesStream",
  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
}
```

---

## ðŸŽ¨ Connector Definition (UI)

### File Structure

**File Name:** `connectorDefinition.json` or `cveBuster_connectorDefinition.json`

**Structure:** Plain object (NOT wrapped in array)

```json
{
  "name": "cveBusterVulnerabilitiesConnectorDefinition",
  "apiVersion": "2024-01-01-preview",
  "type": "Microsoft.SecurityInsights/dataConnectorDefinitions",
  "kind": "Customizable",
  "properties": {
    "connectorUiConfig": {
      "id": "cveBusterVulnerabilitiesConnector",
      "title": "cveBuster Vulnerability Scanner",
      "publisher": "cveBuster",
      "descriptionMarkdown": "...",
      "graphQueriesTableName": "cveBusterVulnerabilities_CL",
      "graphQueries": [...],
      "sampleQueries": [...],
      "dataTypes": [...],
      "connectivityCriteria": [...],
      "availability": {...},
      "permissions": {...},
      "instructionSteps": [...]
    }
  }
}
```

**âš ï¸ NOTE:** Connector definition is NOT wrapped in an array (unlike other files).

### Required Configuration Elements

#### 1. Connector Identification
```json
"id": "cveBusterVulnerabilitiesConnector",
"title": "cveBuster Vulnerability Scanner",
"publisher": "cveBuster"
```

**Note:** The `id` value MUST match `connectorDefinitionName` in polling config.

#### 2. Table Reference
```json
"graphQueriesTableName": "cveBusterVulnerabilities_CL"
```

#### 3. Instruction Steps (User Input)
```json
"instructionSteps": [
  {
    "title": "Configure Connection",
    "description": "Enter your cveBuster API endpoint and authentication key.",
    "instructions": [
      {
        "type": "Textbox",
        "parameters": {
          "label": "API Endpoint URL",
          "placeholder": "http://cvebuster.eastus.cloudapp.azure.com:5000/api/vulnerabilities",
          "name": "apiEndpoint"
        }
      },
      {
        "type": "Textbox",
        "parameters": {
          "label": "API Key",
          "placeholder": "Enter your API key",
          "name": "apiKey"
        }
      },
      {
        "type": "ConnectionToggleButton",
        "parameters": {}
      }
    ]
  }
]
```

---

## ðŸš¨ Error Handling

### HTTP Status Codes

| Status Code | Description | Action |
|-------------|-------------|--------|
| `200` | Success | Process response data |
| `401` | Unauthorized - Invalid API key | Verify API key is correct |
| `500` | Internal Server Error | Retry with exponential backoff |

### Error Response Format

```json
{
  "error": "Unauthorized"
}
```

### CCF Error Handling Configuration

Already configured in request section:
```json
"request": {
  "retryCount": 3,
  "timeoutInSeconds": 60
}
```

---

## ðŸ“ Complete CCF Connector Example

### File 1: pollingConfig.json (or cveBuster_PollerConfig.json)

```json
[
  {
    "name": "cveBusterVulnerabilitiesPoller",
    "apiVersion": "2022-10-01-preview",
    "type": "Microsoft.SecurityInsights/dataConnectors",
    "kind": "RestApiPoller",
    "properties": {
      "connectorDefinitionName": "cveBusterVulnerabilitiesConnector",
      "dcrConfig": {
        "streamName": "Custom-cveBusterVulnerabilitiesStream",
        "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
        "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
      },
      "dataType": "cveBuster Vulnerabilities",
      "auth": {
        "type": "APIKey",
        "ApiKey": "[[parameters('apiKey')]",
        "ApiKeyName": "Authorization"
      },
      "request": {
        "apiEndpoint": "[[parameters('apiEndpoint')]",
        "rateLimitQPS": 10,
        "queryWindowInMin": 5,
        "httpMethod": "GET",
        "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
        "startTimeAttributeName": "createdAt__gt",
        "endTimeAttributeName": "createdAt__lt",
        "retryCount": 3,
        "timeoutInSeconds": 60,
        "headers": {
          "Accept": "application/json",
          "User-Agent": "cveBuster"
        }
      },
      "paging": {
        "pagingType": "NextPageToken",
        "nextPageTokenJsonPath": "$.next_token",
        "NextPageParaName": "next_token",
        "PageSize": "50",
        "PageSizeParameterName": "page_size"
      },
      "response": {
        "eventsJsonPaths": [
          "$.vulnerabilities"
        ]
      }
    }
  }
]
```

---

## ðŸ” Testing & Validation

### Test API Endpoint

```bash
# Test basic connectivity
curl -H "Authorization: cvebuster-demo-key-12345" \
  "http://cvebuster.eastus.cloudapp.azure.com:5000/api/vulnerabilities?page_size=2"
```

### Expected Response
```json
{
  "vulnerabilities": [
    {
      "MachineName": "LoadBalancer01",
      "VulnId": "CVE-2021-26855",
      ...
    },
    {
      "MachineName": "ProdServer03",
      "VulnId": "CVE-2021-3156",
      ...
    }
  ],
  "next_token": "Mg==",
  "total_filtered": 505,
  "page_size": 2,
  "offset": 0
}
```

### Test Time Filtering

```bash
# Get vulnerabilities from last 2 minutes (most records have recent timestamps for testing)
NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
TWO_MIN_AGO=$(date -u -d '2 minutes ago' +"%Y-%m-%dT%H:%M:%SZ")

curl -H "Authorization: cvebuster-demo-key-12345" \
  "http://cvebuster.eastus.cloudapp.azure.com:5000/api/vulnerabilities?createdAt__gt=${TWO_MIN_AGO}&createdAt__lt=${NOW}&page_size=10"
```

---

## ðŸ“Œ Key Takeaways for Agent Builders

### âœ… DO

1. **Wrap polling config in array** with full ARM resource structure
2. **Use `NextPageToken` pagination type** (not LinkHeader)
3. **Set PageSize as string** `"50"` (not integer)
4. **Use `$.vulnerabilities` JSONPath** for events extraction
5. **Include all 20 data fields** in table schema
6. **Wrap table definition in array** with ARM resource structure
7. **Wrap DCR in array** with ARM resource structure
8. **Keep connector definition as plain object** (no array wrapper)
9. **Use direct API key** in Authorization header (no Bearer prefix)
10. **Set `queryWindowInMin` to 5** for incremental sync

### âŒ DON'T

1. Don't use plain object structure for polling config
2. Don't use `LinkHeader` pagination type
3. Don't use `$.data` for events JSONPath (it's `$.vulnerabilities`)
4. Don't omit required ARM resource properties (name, apiVersion, type, kind)
5. Don't use integer for PageSize (must be string)
6. Don't forget time filtering parameters (createdAt__gt, createdAt__lt)
7. Don't add Bearer prefix to API key

---

## ðŸ“ž Support

**API Endpoint:** `http://cvebuster.eastus.cloudapp.azure.com:5000/api/vulnerabilities`  
**Default API Key:** `cvebuster-demo-key-12345`  
**Recommended Polling Frequency:** 5 minutes  
**Recommended Page Size:** 50 records
