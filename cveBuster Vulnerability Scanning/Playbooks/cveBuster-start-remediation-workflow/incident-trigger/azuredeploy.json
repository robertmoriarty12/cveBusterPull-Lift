{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "title": "cveBuster-start-remediation-workflow",
        "description": "This playbook initiates automated remediation workflows for critical vulnerabilities detected in Microsoft Sentinel incidents. It triggers cveBuster's remediation API to automatically patch systems, restart services, and apply security hardening configurations. Success or failure status is reported back as incident comments.",
        "prerequisites": [
            "cveBuster remediation API endpoint must be accessible from Azure Logic Apps",
            "cveBuster platform must have remediation automation enabled",
            "Target systems must be managed by cveBuster with remediation policies configured"
        ],
        "postDeployment": [
            "1. Authorize the Microsoft Sentinel connection in the Logic App.",
            "2. Assign Microsoft Sentinel Responder role to the playbook's managed identity.",
            "3. Update the HTTP action URI if your cveBuster API endpoint differs from the default.",
            "4. Attach this playbook to an **automation rule** for critical/high severity incidents only.",
            "5. Test the workflow in a non-production environment before enabling for production incidents.",
            "[Learn more about automation rules](https://docs.microsoft.com/azure/sentinel/automate-incident-handling-with-automation-rules)"
        ],
        "lastUpdateTime": "2026-01-18T00:00:00.000Z",
        "entities": [],
        "tags": ["Remediation", "Automation", "Response"],
        "support": {
            "tier": "Community"
        },
        "author": {
            "name": "cveBuster"
        }
    },
    "parameters": {
        "PlaybookName": {
            "defaultValue": "cveBuster-start-remediation-workflow",
            "type": "string",
            "metadata": {
                "description": "Name of the Logic App/Playbook"
            }
        },
        "cveBusterRemediationEndpoint": {
            "defaultValue": "http://cvebuster.eastus.cloudapp.azure.com:5000/api/bobvm",
            "type": "string",
            "metadata": {
                "description": "cveBuster remediation API endpoint"
            }
        }
    },
    "variables": {
        "AzureSentinelConnectionName": "[concat('azuresentinel-', parameters('PlaybookName'))]"
    },
    "resources": [
        {
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "name": "[variables('AzureSentinelConnectionName')]",
            "location": "[resourceGroup().location]",
            "kind": "V1",
            "properties": {
                "displayName": "[variables('AzureSentinelConnectionName')]",
                "customParameterValues": {},
                "parameterValueType": "Alternative",
                "api": {
                    "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/azuresentinel')]"
                }
            }
        },
        {
            "type": "Microsoft.Logic/workflows",
            "apiVersion": "2017-07-01",
            "name": "[parameters('PlaybookName')]",
            "location": "[resourceGroup().location]",
            "tags": {
                "hidden-SentinelTemplateName": "cveBuster-start-remediation-workflow",
                "hidden-SentinelTemplateVersion": "1.0"
            },
            "identity": {
                "type": "SystemAssigned"
            },
            "dependsOn": [
                "[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]"
            ],
            "properties": {
                "state": "Enabled",
                "definition": {
                    "$schema": "https://schema.management.azure.com/providers/Microsoft.Logic/schemas/2016-06-01/workflowdefinition.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "$connections": {
                            "defaultValue": {},
                            "type": "Object"
                        },
                        "cveBusterRemediationEndpoint": {
                            "defaultValue": "[parameters('cveBusterRemediationEndpoint')]",
                            "type": "string"
                        }
                    },
                    "triggers": {
                        "Microsoft_Sentinel_incident": {
                            "type": "ApiConnectionWebhook",
                            "inputs": {
                                "host": {
                                    "connection": {
                                        "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                    }
                                },
                                "body": {
                                    "callback_url": "@listCallbackUrl()"
                                },
                                "path": "/incident-creation"
                            }
                        }
                    },
                    "actions": {
                        "Trigger_cveBuster_remediation": {
                            "runAfter": {},
                            "type": "Http",
                            "inputs": {
                                "uri": "@parameters('cveBusterRemediationEndpoint')",
                                "method": "GET"
                            },
                            "runtimeConfiguration": {
                                "contentTransfer": {
                                    "transferMode": "Chunked"
                                }
                            }
                        },
                        "Check_remediation_status": {
                            "actions": {
                                "Add_success_comment_to_incident": {
                                    "type": "ApiConnection",
                                    "inputs": {
                                        "host": {
                                            "connection": {
                                                "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                            }
                                        },
                                        "method": "post",
                                        "body": {
                                            "incidentArmId": "@triggerBody()?['object']?['id']",
                                            "message": "<pre>✅ AUTOMATED REMEDIATION COMPLETED\n\nMicrosoft Sentinel triggered cveBuster automated remediation workflow.\n\nACTIONS TAKEN:\n• Security patches deployed to affected systems\n• Vulnerable services restarted with updated configurations\n• Network access controls updated to mitigate exploit vectors\n• System configurations hardened per security baseline\n• Verification scans completed - vulnerabilities resolved\n\nAll critical vulnerabilities have been successfully remediated. Systems are now compliant with security policies.</pre>"
                                        },
                                        "path": "/Incidents/Comment"
                                    }
                                }
                            },
                            "runAfter": {
                                "Trigger_cveBuster_remediation": [
                                    "Succeeded",
                                    "TimedOut",
                                    "Skipped",
                                    "Failed"
                                ]
                            },
                            "else": {
                                "actions": {
                                    "Add_failure_comment_to_incident": {
                                        "type": "ApiConnection",
                                        "inputs": {
                                            "host": {
                                                "connection": {
                                                    "name": "@parameters('$connections')['azuresentinel']['connectionId']"
                                                }
                                            },
                                            "method": "post",
                                            "body": {
                                                "incidentArmId": "@triggerBody()?['object']?['id']",
                                                "message": "<pre>❌ AUTOMATED REMEDIATION FAILED\n\nMicrosoft Sentinel triggered cveBuster remediation workflow, but one or more tasks failed to complete.\n\nPOSSIBLE CAUSES:\n• Target systems offline or unreachable\n• Insufficient permissions to apply patches\n• Patch deployment conflicts or errors\n• Service restart failures\n• Network connectivity issues\n\nREQUIRED ACTION: Manual review and remediation needed. Check cveBuster platform logs for detailed error information.</pre>"
                                            },
                                            "path": "/Incidents/Comment"
                                        }
                                    }
                                }
                            },
                            "expression": {
                                "and": [
                                    {
                                        "equals": [
                                            "@outputs('Trigger_cveBuster_remediation')?['statusCode']",
                                            200
                                        ]
                                    }
                                ]
                            },
                            "type": "If"
                        }
                    },
                    "outputs": {}
                },
                "parameters": {
                    "$connections": {
                        "value": {
                            "azuresentinel": {
                                "connectionId": "[resourceId('Microsoft.Web/connections', variables('AzureSentinelConnectionName'))]",
                                "connectionName": "[variables('AzureSentinelConnectionName')]",
                                "id": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Web/locations/', resourceGroup().location, '/managedApis/azuresentinel')]",
                                "connectionProperties": {
                                    "authentication": {
                                        "type": "ManagedServiceIdentity"
                                    }
                                }
                            }
                        }
                    },
                    "cveBusterRemediationEndpoint": {
                        "value": "[parameters('cveBusterRemediationEndpoint')]"
                    }
                }
            }
        }
    ]
}
