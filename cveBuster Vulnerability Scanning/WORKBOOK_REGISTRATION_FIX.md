# Workbook Registration Fix

## Issue Encountered

During solution deployment, we encountered an ARM template validation error:

```
sentinel-aliftpull/Microsoft.SecurityInsights/sentinel-aliftpull-wb-aaaaaaaaaaaaa
Microsoft.OperationalInsights/workspaces/providers/contentTemplates
BadRequest 

properties.contentId is required (Code: BadRequestException)
```

Additionally, the ARM-TTK validation showed:

```
Parameters Without Default Must Exist In CreateUIDefinition
[-] Parameters Without Default Must Exist In CreateUIDefinition (27 ms)
    workbook1-name does not have a default value, and is not defined in CreateUIDefinition.outputs
```

## Root Cause

The cveBuster workbook was created in `Workbooks/cveBuster.json` and referenced in `Data/Solution_cveBuster.json`, but it was **not registered** in the global workbook registry file at:

```
C:\github\Azure-Sentinel\Workbooks\WorkbooksMetadata.json
```

The Azure Sentinel solution build process (`createSolutionV3.ps1`) requires all workbooks to be registered in this global metadata file to:
- Generate proper default values for workbook parameters
- Create valid contentId properties in ARM templates
- Ensure proper workbook deployment through contentTemplates resources

## Solution Applied

Added the cveBuster workbook entry to `Workbooks/WorkbooksMetadata.json`:

```json
{
    "workbookKey": "cveBusterWorkbook",
    "logoFileName": "Azure_Sentinel.svg",
    "description": "Comprehensive visibility into vulnerability scan data from cveBuster, including CVE details, asset risk profiles, patch status, and exploit intelligence.",
    "dataTypesDependencies": [
        "cveBusterVulnerabilities_CL"
    ],
    "dataConnectorsDependencies": [
        "cveBusterVulnerabilitiesLogs_ccf",
        "cveBusterVulnerabilitiesPush_ccf"
    ],
    "previewImagesFileNames": [],
    "version": "1.0.0",
    "title": "cveBuster Vulnerability Scanner Dashboard",
    "templateRelativePath": "cveBuster.json",
    "subtitle": "",
    "provider": "cveBuster"
}
```

### Key Fields Explained

- **workbookKey**: Must match the `fromTemplateId` in the workbook JSON (without "sentinel-" prefix)
- **title**: Becomes the default value for the `workbook1-name` parameter in mainTemplate.json
- **templateRelativePath**: Path to workbook JSON file relative to solution's Workbooks folder
- **dataTypesDependencies**: Custom log tables used by workbook queries
- **dataConnectorsDependencies**: Data connectors that feed data to this workbook

## Verification

After adding the metadata entry and rebuilding the solution:

1. ✅ The `workbook1-name` parameter in `Package/mainTemplate.json` now has proper defaultValue:
   ```json
   "workbook1-name": {
       "type": "string",
       "defaultValue": "cveBuster Vulnerability Scanner Dashboard",
       "minLength": 1,
       "metadata": {
           "description": "Name for the workbook"
       }
   }
   ```

2. ✅ The workbook contentTemplates resource includes all required properties including `contentId`

3. ✅ ARM-TTK validation passes without errors related to workbook parameters

## Important Notes for Future Development

**⚠️ CRITICAL**: When creating a new workbook for an Azure Sentinel solution, you MUST:

1. Create the workbook JSON in the solution's `Workbooks/` folder
2. Add the workbook path to `Data/Solution_*.json` in the `Workbooks` array
3. **Register the workbook** in `C:\github\Azure-Sentinel\Workbooks\WorkbooksMetadata.json`
4. Rebuild the solution using `createSolutionV3.ps1`

Missing step 3 will cause ARM template validation failures during deployment.

## Files Modified

- `C:\github\Azure-Sentinel\Workbooks\WorkbooksMetadata.json` - Added cveBuster workbook registration
- `Package/mainTemplate.json` - Auto-regenerated with correct workbook parameter defaults

## Related Files

- Workbook source: `Workbooks/cveBuster.json`
- Solution definition: `Data/Solution_cveBuster.json`
- Generated package: `Package/mainTemplate.json`
