#!/bin/bash
# Complete cveBuster Setup and Documentation Server Script
# This script handles full VM setup from scratch, including:
# - System updates
# - Python installation
# - Repository cloning
# - Virtual environment setup
# - Dependencies installation
# - Data generation
# - API documentation server startup

set -e  # Exit on error

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
PORT=${PORT:-80}
INSTALL_MODE=${1:-"full"}  # Options: "full", "dev", "docs-only"
REPO_URL="https://github.com/robertmoriarty12/cveBusterPull-Lift.git"
REPO_BRANCH="main"
INSTALL_DIR="${INSTALL_DIR:-.}"
VENV_DIR="venv"
API_PORT=${API_PORT:-5000}

# Functions
print_header() {
    echo ""
    echo "=================================================="
    echo -e "${BLUE}$1${NC}"
    echo "=================================================="
    echo ""
}

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

print_error() {
    echo -e "${RED}✗ $1${NC}"
}

check_root() {
    if [ "$EUID" -ne 0 ]; then
        print_error "This script requires root privileges for port 80"
        echo "Please run with: sudo bash $0 $INSTALL_MODE"
        exit 1
    fi
}

check_command() {
    if ! command -v $1 &> /dev/null; then
        return 1
    fi
    return 0
}

install_dependencies() {
    print_header "Installing System Dependencies"
    
    # Update package list
    print_warning "Updating package manager..."
    apt-get update
    
    # Install Python and dependencies
    print_warning "Installing Python and dependencies..."
    apt-get install -y \
        python3 \
        python3-pip \
        python3-venv \
        git \
        curl \
        wget \
        build-essential
    
    print_success "System dependencies installed"
}

check_server_directory() {
    print_header "Checking for Server Directory"
    
    if [ ! -d "cveBuster Vulnerability Scanning/Server" ]; then
        print_error "Server directory not found at: cveBuster Vulnerability Scanning/Server"
        echo ""
        echo "Please clone the repository first:"
        echo ""
        echo "  git clone --branch main https://github.com/robertmoriarty12/cveBusterPull-Lift.git cveBuster-temp"
        echo "  mv 'cveBuster-temp/cveBuster Vulnerability Scanning/Server' 'cveBuster Vulnerability Scanning/'"
        echo "  rm -rf cveBuster-temp"
        echo ""
        exit 1
    fi
    
    print_success "Server directory found"
}

setup_python_environment() {
    print_header "Setting Up Python Virtual Environment"
    
    local SERVER_DIR="cveBuster Vulnerability Scanning/Server"
    
    if [ ! -d "$SERVER_DIR" ]; then
        print_error "Server directory not found at $SERVER_DIR"
        exit 1
    fi
    
    cd "$SERVER_DIR"
    
    # Create virtual environment
    print_warning "Creating virtual environment..."
    python3 -m venv "$VENV_DIR"
    
    # Activate virtual environment
    source "$VENV_DIR/bin/activate"
    print_success "Virtual environment created and activated"
    
    # Upgrade pip
    print_warning "Upgrading pip..."
    pip install --upgrade pip setuptools wheel
    
    # Install Flask
    print_warning "Installing Flask..."
    pip install Flask
    
    # Install additional useful packages
    print_warning "Installing additional packages..."
    pip install python-dotenv gunicorn
    
    print_success "Python environment configured"
    
    # Create requirements.txt for future reference
    pip freeze > requirements.txt
    print_success "Created requirements.txt"
    
    cd - > /dev/null
}

generate_sample_data() {
    print_header "Generating Sample Data"
    
    local SERVER_DIR="cveBuster Vulnerability Scanning/Server"
    local DATA_FILE="$SERVER_DIR/cvebuster_data.json"
    
    # Check if data already exists
    if [ -f "$DATA_FILE" ]; then
        print_warning "Data file already exists at $DATA_FILE"
        return
    fi
    
    print_warning "Generating sample vulnerability data..."
    
    # Create sample data JSON
    cat > "$DATA_FILE" << 'EOF'
[
    {
        "id": "CVE-2024-0001",
        "cveId": "CVE-2024-0001",
        "title": "Sample Vulnerability 1",
        "description": "This is a sample vulnerability for testing",
        "severity": "HIGH",
        "cvssScore": 7.5,
        "LastModified": "2024-01-01T10:00:00Z",
        "affected_packages": ["package1", "package2"],
        "remediation": "Update to version 2.0 or higher"
    },
    {
        "id": "CVE-2024-0002",
        "cveId": "CVE-2024-0002",
        "title": "Sample Vulnerability 2",
        "description": "Another sample vulnerability",
        "severity": "CRITICAL",
        "cvssScore": 9.1,
        "LastModified": "2024-01-02T14:30:00Z",
        "affected_packages": ["package3"],
        "remediation": "Immediate patching required"
    },
    {
        "id": "CVE-2024-0003",
        "cveId": "CVE-2024-0003",
        "title": "Sample Vulnerability 3",
        "description": "Medium severity vulnerability",
        "severity": "MEDIUM",
        "cvssScore": 5.3,
        "LastModified": "2024-01-03T09:15:00Z",
        "affected_packages": ["package4", "package5"],
        "remediation": "Schedule patching within 30 days"
    }
]
EOF
    
    print_success "Sample data generated at $DATA_FILE"
}

setup_docs_server() {
    print_header "Setting Up API Documentation Server"
    
    local SERVER_DIR="cveBuster Vulnerability Scanning/Server"
    local DOCS_DIR="$SERVER_DIR/api_docs"
    
    if [ ! -d "$DOCS_DIR" ]; then
        print_warning "API docs directory not found at $DOCS_DIR"
        print_warning "Skipping documentation server setup"
        return
    fi
    
    print_success "API documentation files found at $DOCS_DIR"
}

configure_api_service() {
    print_header "Configuring API Service"
    
    local SERVER_DIR="cveBuster Vulnerability Scanning/Server"
    
    print_warning "Creating systemd service for API..."
    
    cat > /etc/systemd/system/cvebuster-api.service << EOF
[Unit]
Description=cveBuster API Server
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=$(pwd)/$SERVER_DIR
Environment="PATH=$(pwd)/$SERVER_DIR/$VENV_DIR/bin"
ExecStart=$(pwd)/$SERVER_DIR/$VENV_DIR/bin/python app_paginated.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF
    
    print_success "API service configured at /etc/systemd/system/cvebuster-api.service"
}

configure_docs_service() {
    print_header "Configuring Documentation Service"
    
    local SERVER_DIR="cveBuster Vulnerability Scanning/Server"
    local DOCS_DIR="$SERVER_DIR/api_docs"
    
    print_warning "Creating systemd service for documentation..."
    
    cat > /etc/systemd/system/cvebuster-docs.service << EOF
[Unit]
Description=cveBuster API Documentation Server
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=$DOCS_DIR
ExecStart=/usr/bin/python3 $DOCS_DIR/server_linux.py
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
Environment="PORT=$PORT"

[Install]
WantedBy=multi-user.target
EOF
    
    print_success "Documentation service configured at /etc/systemd/system/cvebuster-docs.service"
}

start_services() {
    print_header "Starting Services"
    
    # Reload systemd
    systemctl daemon-reload
    
    # Enable services
    print_warning "Enabling services..."
    systemctl enable cvebuster-api
    systemctl enable cvebuster-docs
    
    # Start services
    print_warning "Starting API service..."
    systemctl start cvebuster-api
    
    print_warning "Starting documentation service..."
    systemctl start cvebuster-docs
    
    # Wait a moment for services to start
    sleep 2
    
    # Check status
    print_header "Service Status"
    systemctl status cvebuster-api --no-pager
    echo ""
    systemctl status cvebuster-docs --no-pager
    
    print_success "Services started successfully"
}

show_usage() {
    cat << EOF

${BLUE}==================================================${NC}
${BLUE}cveBuster Setup Complete!${NC}
${BLUE}==================================================${NC}

${GREEN}Services created (not yet started):${NC}
  API Service:    /etc/systemd/system/cvebuster-api.service
  Docs Service:   /etc/systemd/system/cvebuster-docs.service

${GREEN}To start services:${NC}
  sudo systemctl start cvebuster-api
  sudo systemctl start cvebuster-docs

${GREEN}Service Management:${NC}
  sudo systemctl {start|stop|restart|status} cvebuster-api
  sudo systemctl {start|stop|restart|status} cvebuster-docs

${GREEN}Access (after starting):${NC}
  API:            http://localhost:$API_PORT/api/vulnerabilities
  Documentation:  http://localhost:$PORT

${GREEN}Test with curl:${NC}
  curl -H "Authorization: cvebuster-demo-key-12345" \\
    http://localhost:$API_PORT/api/vulnerabilities

${GREEN}View Logs:${NC}
  sudo journalctl -u cvebuster-api -f
  sudo journalctl -u cvebuster-docs -f

${GREEN}Configuration Paths:${NC}
  API Code:       ./cveBuster Vulnerability Scanning/Server/app_paginated.py
  Docs:           ./cveBuster Vulnerability Scanning/Server/api_docs/
  Data:           ./cveBuster Vulnerability Scanning/Server/cvebuster_data.json

${GREEN}Enable services on boot:${NC}
  sudo systemctl enable cvebuster-api
  sudo systemctl enable cvebuster-docs

EOF
}

# Main execution
main() {
    print_header "cveBuster Complete Setup Script"
    
    echo "Setup Mode: $INSTALL_MODE"
    echo "Port: $PORT"
    echo "Installation Directory: $INSTALL_DIR"
    echo ""
    
    case "$INSTALL_MODE" in
        full)
            check_root
            check_server_directory
            install_dependencies
            setup_python_environment
            generate_sample_data
            setup_docs_server
            configure_api_service
            configure_docs_service
            print_header "Setup Complete!"
            print_success "All components installed and configured"
            show_usage
            ;;
        dev)
            check_root
            check_server_directory
            install_dependencies
            setup_python_environment
            generate_sample_data
            setup_docs_server
            print_header "Setup Complete!"
            print_success "All components installed and configured"
            show_usage
            ;;
        docs-only)
            check_root
            print_warning "Setting up documentation server only..."
            print_warning "Installing Python..."
            apt-get update
            apt-get install -y python3
            start_docs_service_only
            show_usage
            ;;
        *)
            print_error "Unknown mode: $INSTALL_MODE"
            echo "Usage: bash $0 {full|dev|docs-only}"
            exit 1
            ;;
    esac
}

start_docs_service_only() {
    local SERVER_DIR="cveBuster Vulnerability Scanning/Server"
    local DOCS_DIR="$SERVER_DIR/api_docs"
    
    if [ ! -d "$DOCS_DIR" ]; then
        print_error "API docs directory not found"
        exit 1
    fi
    
    systemctl daemon-reload
    systemctl enable cvebuster-docs
    systemctl start cvebuster-docs
    systemctl status cvebuster-docs --no-pager
    print_success "Documentation server started"
}

# Run main function
main
