#!/usr/bin/env python3
"""
Simple HTTP server for serving cveBuster API documentation on Linux/Ubuntu.
Run: sudo python3 server.py  (for port 80, or use port > 1024 without sudo)
Then navigate to: http://localhost:80
"""

import http.server
import socketserver
import os
import sys
from pathlib import Path


def main():
    """Start the HTTP server."""
    # Configuration
    PORT = int(os.environ.get('PORT', 80))
    HOST = '0.0.0.0'
    
    class APIDocumentationHandler(http.server.SimpleHTTPRequestHandler):
        """Custom HTTP request handler for API documentation."""

        def end_headers(self):
            """Add custom headers to prevent caching of dynamic content."""
            self.send_header('Cache-Control', 'no-store, no-cache, must-revalidate, max-age=0')
            self.send_header('Expires', '0')
            super().end_headers()

        def do_GET(self):
            """Handle GET requests."""
            # Route root requests to index.html
            if self.path == '/' or self.path == '':
                self.path = '/index.html'
            
            # Serve files
            return super().do_GET()

        def log_message(self, format, *args):
            """Log HTTP requests with timestamps."""
            import time
            timestamp = time.strftime('%Y-%m-%d %H:%M:%S', time.localtime())
            print(f'[{timestamp}] {format % args}')

    try:
        # Change to the directory containing this script
        script_dir = Path(__file__).parent.absolute()
        os.chdir(script_dir)
        
        # Create the server
        socketserver.TCPServer.allow_reuse_address = True
        with socketserver.TCPServer((HOST, PORT), APIDocumentationHandler) as httpd:
            print("=" * 70)
            print("cveBuster API Documentation Server")
            print("=" * 70)
            print(f"Server started at: http://{HOST}:{PORT}")
            print(f"Serving files from: {script_dir}")
            print()
            print("Press Ctrl+C to stop the server")
            print("=" * 70)
            print()
            
            # Serve requests
            httpd.serve_forever()
            
    except KeyboardInterrupt:
        print("\n\nShutting down server...")
        sys.exit(0)
    except PermissionError:
        print(f"\nError: Permission denied to bind to port {PORT}")
        print(f"Try one of the following:")
        print(f"  1. Run with sudo: sudo python3 server.py")
        print(f"  2. Use a port > 1024: PORT=8000 python3 server.py")
        print(f"  3. Modify the PORT variable in this script")
        sys.exit(1)
    except Exception as e:
        print(f"\nError: {e}")
        sys.exit(1)


if __name__ == '__main__':
    main()
