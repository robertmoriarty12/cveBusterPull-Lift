#!/usr/bin/env python3
"""
cveBuster Push Client Web Server
Serves web-based push client on port 8080 with integrated vulnerability data generation and Sentinel integration.
Run: python3 server.py
Then navigate to: http://localhost:8080
"""

import json
import random
import os
from datetime import datetime, timedelta
from pathlib import Path
from flask import Flask, render_template_string, request, jsonify
from azure.identity import ClientSecretCredential
from azure.monitor.ingestion import LogsIngestionClient
from azure.core.exceptions import HttpResponseError

app = Flask(__name__)

# Real Windows CVEs for BobVM
BOBVM_CVES = [
    {
        "VulnId": "CVE-2024-49113",
        "VulnTitle": "Windows Kerberos Elevation of Privilege Vulnerability",
        "Severity": "Critical",
        "CVSS": 9.8,
        "AssetCriticality": "High",
        "PatchAvailable": False,
        "ExploitAvailable": True
    },
    {
        "VulnId": "CVE-2024-49112",
        "VulnTitle": "Windows Remote Code Execution in SMB Protocol",
        "Severity": "Critical",
        "CVSS": 10.0,
        "AssetCriticality": "High",
        "PatchAvailable": False,
        "ExploitAvailable": True
    },
    {
        "VulnId": "CVE-2024-48967",
        "VulnTitle": "Windows NTLM Security Feature Bypass Vulnerability",
        "Severity": "High",
        "CVSS": 8.8,
        "AssetCriticality": "High",
        "PatchAvailable": True,
        "ExploitAvailable": False
    },
    {
        "VulnId": "CVE-2024-48951",
        "VulnTitle": "Windows Graphics Component Remote Code Execution",
        "Severity": "Critical",
        "CVSS": 9.6,
        "AssetCriticality": "Medium",
        "PatchAvailable": True,
        "ExploitAvailable": True
    },
    {
        "VulnId": "CVE-2025-0001-ZERODAY",
        "VulnTitle": "Windows Kernel Privilege Escalation (Zero Day)",
        "Severity": "Critical",
        "CVSS": 9.9,
        "AssetCriticality": "High",
        "PatchAvailable": False,
        "ExploitAvailable": False
    }
]


def generate_bobvm_vulnerabilities(now):
    """Generate 5 specific real Windows CVEs for BobVM"""
    bobvm_vulns = []
    for cve_data in BOBVM_CVES:
        seconds_ago = random.randint(0, 300)
        last_seen = now - timedelta(seconds=seconds_ago)
        days_before_last_seen = random.randint(1, 30)
        first_seen = last_seen - timedelta(days=days_before_last_seen)

        vuln = {
            "VulnId": cve_data["VulnId"],
            "VulnTitle": cve_data["VulnTitle"],
            "Severity": cve_data["Severity"],
            "CVSS": cve_data["CVSS"],
            "MachineName": "BobVM",
            "AssetCriticality": cve_data["AssetCriticality"],
            "PatchAvailable": cve_data["PatchAvailable"],
            "ExploitAvailable": cve_data["ExploitAvailable"],
            "ExploitedInWild": cve_data["ExploitAvailable"] and random.choice([True, False]),
            "FirstSeen": first_seen.strftime("%Y-%m-%dT%H:%M:%SZ"),
            "LastSeen": last_seen.strftime("%Y-%m-%dT%H:%M:%SZ"),
            "LastScanTime": now.strftime("%Y-%m-%dT%H:%M:%SZ"),
            "Source": "cveBuster"
        }
        bobvm_vulns.append(vuln)
    return bobvm_vulns


def generate_vulnerability_data(num_records=500):
    """Generate mock vulnerability data with all records within last 5 minutes"""
    vulnerabilities = []
    severity_levels = ["Critical", "High", "Medium", "Low"]
    machine_names = [f"SRV-{random.choice(['WEB', 'APP', 'DB', 'DC'])}-{i:03d}"
                     for i in range(1, 51)]
    
    now = datetime.utcnow()
    vulnerabilities.extend(generate_bobvm_vulnerabilities(now))

    for i in range(1, num_records + 1):
        seconds_ago = random.randint(0, 300)
        last_seen = now - timedelta(seconds=seconds_ago)
        days_before_last_seen = random.randint(1, 30)
        first_seen = last_seen - timedelta(days=days_before_last_seen)

        severity = random.choice(severity_levels)
        cvss = round(random.uniform(4.0, 10.0), 1)
        exploit_available = random.choice([True, False])

        vuln = {
            "VulnId": f"CVE-2024-{10000 + i}",
            "VulnTitle": f"Security Vulnerability {i}",
            "Severity": severity,
            "CVSS": cvss,
            "MachineName": random.choice(machine_names),
            "AssetCriticality": random.choice(["High", "Medium", "Low"]),
            "PatchAvailable": random.choice([True, False]),
            "ExploitAvailable": exploit_available,
            "ExploitedInWild": exploit_available and random.choice([True, False]),
            "FirstSeen": first_seen.strftime("%Y-%m-%dT%H:%M:%SZ"),
            "LastSeen": last_seen.strftime("%Y-%m-%dT%H:%M:%SZ"),
            "LastScanTime": now.strftime("%Y-%m-%dT%H:%M:%SZ"),
            "Source": "cveBuster"
        }
        vulnerabilities.append(vuln)

    return vulnerabilities


@app.route('/')
def index():
    """Serve the main push client web interface"""
    return render_template_string(HTML_TEMPLATE)


@app.route('/api/push', methods=['POST'])
def push_data():
    """Generate data and push to Microsoft Sentinel"""
    try:
        data = request.get_json()
        
        # Extract parameters
        tenant_id = data.get('tenant_id', '').strip()
        client_id = data.get('client_id', '').strip()
        client_secret = data.get('client_secret', '').strip()
        dce_endpoint = data.get('dce_endpoint', '').strip()
        dcr_id = data.get('dcr_id', '').strip()
        stream_name = data.get('stream_name', '').strip()

        # Validate inputs
        if not all([tenant_id, client_id, client_secret, dce_endpoint, dcr_id, stream_name]):
            return jsonify({'error': 'Missing required fields'}), 400

        # Step 1: Generate data (always 500 + 5 BobVM CVEs = 505 total)
        num_records = 500
        vulnerabilities = generate_vulnerability_data(num_records)
        bobvm_count = sum(1 for v in vulnerabilities if v['MachineName'] == 'BobVM')
        general_count = len(vulnerabilities) - bobvm_count
        
        # Step 2: Authenticate with Azure
        credential = ClientSecretCredential(
            tenant_id=tenant_id,
            client_id=client_id,
            client_secret=client_secret
        )

        # Step 3: Create ingestion client
        client = LogsIngestionClient(
            endpoint=dce_endpoint,
            credential=credential,
            logging_enable=True
        )

        # Step 4: Send data to Sentinel
        response = client.upload(
            rule_id=dcr_id,
            stream_name=stream_name,
            logs=vulnerabilities
        )

        return jsonify({
            'success': True,
            'total_records': len(vulnerabilities),
            'bobvm_count': bobvm_count,
            'general_count': general_count,
            'response': str(response) if response else 'HTTP 204 No Content (success)',
            'timestamp': datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')
        }), 200

    except HttpResponseError as e:
        return jsonify({'error': f'Azure API Error: {str(e)}'}), 400
    except Exception as e:
        return jsonify({'error': str(e)}), 500


# Embedded HTML template
HTML_TEMPLATE = '''<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cveBuster Push Client - Web</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #f0f0f0;
            background: #f9f9f9;
        }

        .tab-button {
            flex: 1;
            padding: 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .tab-button:hover {
            background: white;
            color: #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e0e0e0;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status-log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #333;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            line-height: 1.5;
        }

        .log-entry {
            padding: 2px 0;
        }

        .log-entry.success {
            color: #28a745;
        }

        .log-entry.error {
            color: #dc3545;
        }

        .log-entry.info {
            color: #666;
        }

        .log-entry.timestamp {
            color: #999;
            font-size: 12px;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-size: 14px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .field-helper {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            font-style: italic;
        }

        .placeholder-content {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .placeholder-content h3 {
            margin-bottom: 10px;
            color: #666;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 20px;
            }

            .tab-button {
                font-size: 12px;
                padding: 12px;
            }

            .tab-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>cveBuster Push Client</h1>
            <p>Generate vulnerability data and push to Microsoft Sentinel</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('push')">Push Data</button>
            <button class="tab-button" onclick="switchTab('config')">Configuration</button>
            <button class="tab-button" onclick="switchTab('analytics')">Analytics</button>
        </div>

        <!-- Push Data Tab -->
        <div id="push" class="tab-content active">
            <div id="alertContainer"></div>

            <form id="pushForm">
                <div class="form-group">
                    <label for="tenantId">Tenant ID (Directory ID)</label>
                    <input type="text" id="tenantId" placeholder="e.g., 12345678-1234-1234-1234-123456789012" required>
                    <div class="field-helper">The unique identifier of your Azure AD tenant</div>
                </div>

                <div class="form-group">
                    <label for="clientId">Application (Client) ID</label>
                    <input type="text" id="clientId" placeholder="e.g., 12345678-1234-1234-1234-123456789012" required>
                    <div class="field-helper">The application ID of your service principal</div>
                </div>

                <div class="form-group">
                    <label for="clientSecret">Application Secret</label>
                    <input type="password" id="clientSecret" placeholder="Enter your application secret" required>
                    <div class="field-helper">The client secret of your service principal</div>
                </div>

                <div class="form-group">
                    <label for="dceEndpoint">Data Collection Endpoint</label>
                    <input type="text" id="dceEndpoint" placeholder="e.g., https://dcr-12345678.eastus-1.ingest.monitor.azure.com" required>
                    <div class="field-helper">The DCE URL for your Log Analytics workspace</div>
                </div>

                <div class="form-group">
                    <label for="dcrId">Data Collection Rule Immutable ID</label>
                    <input type="text" id="dcrId" placeholder="e.g., dcr-12345678901234567890123456789012" required>
                    <div class="field-helper">The immutable ID of your Data Collection Rule</div>
                </div>

                <div class="form-group">
                    <label for="streamName">Stream Name</label>
                    <input type="text" id="streamName" placeholder="Custom-cveBusterVulnerabilities" value="Custom-cveBusterVulnerabilities" required>
                    <div class="field-helper">The custom log stream to write data to</div>
                </div>

                <div class="form-group">
                    <label>Status Log</label>
                    <div class="status-log" id="statusLog"></div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-primary" id="sendBtn" onclick="sendData()">
                        Generate & Send Data
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="clearLog()">
                        Clear Log
                    </button>
                </div>
            </form>
        </div>

        <!-- Configuration Tab -->
        <div id="config" class="tab-content">
            <div class="placeholder-content">
                <h3>Advanced Configuration</h3>
                <p>Configuration management coming soon...</p>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <div class="placeholder-content">
                <h3>Vulnerability Analytics</h3>
                <p>Analytics dashboard coming soon...</p>
            </div>
        </div>
    </div>

    <script>
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function log(message, type = 'info') {
            const logDiv = document.getElementById('statusLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${escapeHtml(message)}`;
            
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('statusLog').innerHTML = '';
        }

        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function sendData() {
            const form = document.getElementById('pushForm');
            
            // Validate inputs
            if (!form.checkValidity()) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;

            clearLog();
            log('='.repeat(60), 'info');
            log('Starting data generation and push to Sentinel...', 'info');
            log('', 'info');

            try {
                const tenantId = document.getElementById('tenantId').value.trim();
                const clientId = document.getElementById('clientId').value.trim();
                const clientSecret = document.getElementById('clientSecret').value.trim();
                const dceEndpoint = document.getElementById('dceEndpoint').value.trim();
                const dcrId = document.getElementById('dcrId').value.trim();
                const streamName = document.getElementById('streamName').value.trim();

                log(`Generating 500 vulnerability records + 5 BobVM CVEs...`, 'info');

                // Call backend to generate and send data
                const response = await fetch('/api/push', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tenant_id: tenantId,
                        client_id: clientId,
                        client_secret: clientSecret,
                        dce_endpoint: dceEndpoint,
                        dcr_id: dcrId,
                        stream_name: streamName
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to send data');
                }

                log(`✓ Generated ${result.total_records} total records`, 'success');
                log(`  - ${result.bobvm_count} BobVM-specific Windows CVEs`, 'success');
                log(`  - ${result.general_count} general vulnerability records`, 'success');
                log('', 'info');
                
                log('Authenticating with Azure...', 'info');
                log('✓ Authentication successful', 'success');
                log('', 'info');
                
                log('Connecting to Data Collection Endpoint...', 'info');
                log('✓ Connected to DCE', 'success');
                log('', 'info');
                
                log(`Uploading ${result.total_records} records to Sentinel...`, 'info');
                log(`  DCR ID: ${dcrId}`, 'info');
                log(`  Stream: ${streamName}`, 'info');
                log('', 'info');
                
                log('✓ SUCCESS! Data uploaded to Microsoft Sentinel', 'success');
                log(`  Response: ${result.response}`, 'success');
                log(`  Total records sent: ${result.total_records}`, 'success');
                log(`  Timestamp: ${result.timestamp} UTC`, 'success');
                log('  Data should appear in Log Analytics within 5-10 minutes', 'success');

                showAlert(`Successfully sent ${result.total_records} vulnerability records to Sentinel!<br><br>Check Log Analytics in 5-10 minutes:<br><code>cveBusterVulnerabilities_CL | take 10</code>`, 'success');

            } catch (error) {
                log(`✗ ERROR: ${error.message}`, 'error');
                showAlert(`Error: ${error.message}`, 'error');
            } finally {
                sendBtn.disabled = false;
            }
        }

        // Allow Enter key to submit
        document.getElementById('pushForm').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.target.type !== 'textarea') {
                e.preventDefault();
                sendData();
            }
        });
    </script>
</body>
</html>
'''


def main():
    """Start the web server"""
    PORT = int(os.environ.get('PORT', 8080))
    HOST = '0.0.0.0'

    print("=" * 70)
    print("cveBuster Push Client Web Server")
    print("=" * 70)
    print(f"Server starting at: http://{HOST}:{PORT}")
    print()
    print("Press Ctrl+C to stop the server")
    print("=" * 70)
    print()

    try:
        app.run(host=HOST, port=PORT, debug=False)
    except KeyboardInterrupt:
        print("\n\nShutting down server...")
    except Exception as e:
        print(f"\nError: {e}")


if __name__ == '__main__':
    main()
