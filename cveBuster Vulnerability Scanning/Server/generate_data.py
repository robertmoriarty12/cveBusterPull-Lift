import json
import random
from datetime import datetime, timedelta

# Real Windows CVEs for BobVM
BOBVM_CVES = [
    {
        "VulnId": "CVE-2024-49113",
        "VulnTitle": "Windows Kerberos Elevation of Privilege Vulnerability",
        "Severity": "Critical",
        "CVSS": 9.8,
        "AssetCriticality": "High",
        "PatchAvailable": False,
        "ExploitAvailable": True
    },
    {
        "VulnId": "CVE-2024-49112",
        "VulnTitle": "Windows Remote Code Execution in SMB Protocol",
        "Severity": "Critical",
        "CVSS": 10.0,
        "AssetCriticality": "High",
        "PatchAvailable": False,
        "ExploitAvailable": True
    },
    {
        "VulnId": "CVE-2024-48967",
        "VulnTitle": "Windows NTLM Security Feature Bypass Vulnerability",
        "Severity": "High",
        "CVSS": 8.8,
        "AssetCriticality": "High",
        "PatchAvailable": True,
        "ExploitAvailable": False
    },
    {
        "VulnId": "CVE-2024-48951",
        "VulnTitle": "Windows Graphics Component Remote Code Execution",
        "Severity": "Critical",
        "CVSS": 9.6,
        "AssetCriticality": "Medium",
        "PatchAvailable": True,
        "ExploitAvailable": True
    },
    {
        "VulnId": "CVE-2025-0001-ZERODAY",
        "VulnTitle": "Windows Kernel Privilege Escalation (Zero Day)",
        "Severity": "Critical",
        "CVSS": 9.9,
        "AssetCriticality": "High",
        "PatchAvailable": False,
        "ExploitAvailable": False
    }
]

def generate_bobvm_vulnerabilities(now):
    """
    Generate 5 specific real Windows CVEs for BobVM.
    These are generated fresh on each run with recent timestamps.
    """
    bobvm_vulns = []
    
    for cve_data in BOBVM_CVES:
        # All BobVM CVEs are recent (last 2 minutes)
        seconds_ago = random.randint(0, 120)
        last_modified = now - timedelta(seconds=seconds_ago)
        
        # Discovery date is always before last modified
        days_before_modified = random.randint(1, 30)
        discovery_date = last_modified - timedelta(days=days_before_modified)
        
        vuln = {
            "VulnId": cve_data["VulnId"],
            "VulnTitle": cve_data["VulnTitle"],
            "Severity": cve_data["Severity"],
            "CVSS": cve_data["CVSS"],
            "MachineName": "BobVM",
            "AssetCriticality": cve_data["AssetCriticality"],
            "PatchAvailable": cve_data["PatchAvailable"],
            "ExploitAvailable": cve_data["ExploitAvailable"],
            "DiscoveryDate": discovery_date.strftime("%Y-%m-%dT%H:%M:%SZ"),
            "LastModified": last_modified.strftime("%Y-%m-%dT%H:%M:%SZ"),
            "Status": random.choice(["Open", "In Progress"])
        }
        bobvm_vulns.append(vuln)
    
    return bobvm_vulns

def generate_vulnerability_data(num_records=500):
    """
    Generate mock vulnerability data with LastModified distribution:
    - 70% old records (30-90 days ago)
    - 30% recent records (within last 2 minutes)
    
    This ensures records fall within CCF's 5-minute query window for testing.
    
    Also generates 5 specific real Windows CVEs for BobVM on each run.
    """
    vulnerabilities = []
    severity_levels = ["Critical", "High", "Medium", "Low"]
    machine_names = [f"SRV-{random.choice(['WEB', 'APP', 'DB', 'DC'])}-{i:03d}" 
                     for i in range(1, 51)]
    
    now = datetime.utcnow()
    
    # Add BobVM vulnerabilities first
    vulnerabilities.extend(generate_bobvm_vulnerabilities(now))
    
    for i in range(1, num_records + 1):
        # 30% recent (last 2 minutes), 70% old (30-90 days ago)
        if random.random() < 0.30:
            # Recent records - within last 2 minutes (120 seconds)
            seconds_ago = random.randint(0, 120)
            last_modified = now - timedelta(seconds=seconds_ago)
        else:
            # Old records - 30 to 90 days ago
            days_ago = random.randint(30, 90)
            last_modified = now - timedelta(days=days_ago)
        
        # Discovery date is always before last modified
        days_before_modified = random.randint(1, 30)
        discovery_date = last_modified - timedelta(days=days_before_modified)
        
        severity = random.choice(severity_levels)
        cvss = round(random.uniform(4.0, 10.0), 1)
        
        vuln = {
            "VulnId": f"CVE-2024-{10000 + i}",
            "VulnTitle": f"Security Vulnerability {i}",
            "Severity": severity,
            "CVSS": cvss,
            "MachineName": random.choice(machine_names),
            "AssetCriticality": random.choice(["High", "Medium", "Low"]),
            "PatchAvailable": random.choice([True, False]),
            "ExploitAvailable": random.choice([True, False]),
            "DiscoveryDate": discovery_date.strftime("%Y-%m-%dT%H:%M:%SZ"),
            "LastModified": last_modified.strftime("%Y-%m-%dT%H:%M:%SZ"),
            "Status": random.choice(["Open", "In Progress", "Patched"])
        }
        vulnerabilities.append(vuln)
    
    return vulnerabilities

if __name__ == "__main__":
    print("Generating vulnerability records...")
    print("Distribution: 70% old (30-90 days ago), 30% recent (last 2 minutes)")
    print("Including 5 real Windows CVEs for BobVM (refreshed on each run)\n")
    
    data = generate_vulnerability_data(500)
    
    # Count recent vs old
    now = datetime.utcnow()
    recent_count = sum(1 for v in data 
                      if (now - datetime.strptime(v['LastModified'], "%Y-%m-%dT%H:%M:%SZ")).total_seconds() < 120)
    
    # Count BobVM vulnerabilities
    bobvm_count = sum(1 for v in data if v['MachineName'] == 'BobVM')
    bobvm_vulns = [v for v in data if v['MachineName'] == 'BobVM']
    
    with open('cvebuster_data.json', 'w') as f:
        json.dump(data, f, indent=2)
    
    print(f"âœ… Generated {len(data)} total records")
    print(f"   - Recent (last 2 min): {recent_count}")
    print(f"   - Old (30-90 days): {len(data) - recent_count}")
    print(f"\nðŸŽ¯ BobVM Vulnerabilities ({bobvm_count}):")
    for vuln in bobvm_vulns:
        zero_day_marker = " [ZERO DAY]" if "ZERODAY" in vuln['VulnId'] else ""
        print(f"   â€¢ {vuln['VulnId']}: {vuln['VulnTitle']} (CVSS: {vuln['CVSS']}){zero_day_marker}")
    
    print(f"\nSaved to cvebuster_data.json")
