{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "author": "cveBuster - support@cvebuster.com",
    "comments": "Solution template for cveBuster Vulnerability Scanning"
  },
  "parameters": {
    "location": {
      "type": "string",
      "minLength": 1,
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Not used, but needed to pass arm-ttk test `Location-Should-Not-Be-Hardcoded`.  We instead use the `workspace-location` which is derived from the LA workspace"
      }
    },
    "workspace-location": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "[concat('Region to deploy solution resources -- separate from location selection',parameters('location'))]"
      }
    },
    "workspace": {
      "defaultValue": "",
      "type": "string",
      "metadata": {
        "description": "Workspace name for Log Analytics where Microsoft Sentinel is setup"
      }
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "resource group name where Microsoft Sentinel is setup"
      }
    },
    "subscription": {
      "type": "string",
      "defaultValue": "[last(split(subscription().id, '/'))]",
      "metadata": {
        "description": "subscription id where Microsoft Sentinel is setup"
      }
    }
  },
  "variables": {
    "email": "support@cvebuster.com",
    "_email": "[variables('email')]",
    "_solutionName": "cveBuster Vulnerability Scanning",
    "_solutionVersion": "3.0.0",
    "solutionId": "yourcompany.cvebuster-sentinel-solution",
    "_solutionId": "[variables('solutionId')]",
    "workspaceResourceId": "[resourceId('microsoft.OperationalInsights/Workspaces', parameters('workspace'))]",
    "dataConnectorCCPVersion": "1.0.0",
    "_dataConnectorContentIdConnectorDefinition1": "cveBusterVulnerabilitiesConnector",
    "dataConnectorTemplateNameConnectorDefinition1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnectorDefinition1')))]",
    "_dataConnectorContentIdConnections1": "cveBusterVulnerabilitiesConnectorConnections",
    "dataConnectorTemplateNameConnections1": "[concat(parameters('workspace'),'-dc-',uniquestring(variables('_dataConnectorContentIdConnections1')))]",
    "dataCollectionEndpointId1": "[concat('/subscriptions/',parameters('subscription'),'/resourceGroups/',parameters('resourceGroupName'),'/providers/Microsoft.Insights/dataCollectionEndpoints/',parameters('workspace'))]",
    "blanks": "[replace('b', 'b', '')]",
    "_solutioncontentProductId": "[concat(take(variables('_solutionId'),50),'-','sl','-', uniqueString(concat(variables('_solutionId'),'-','Solution','-',variables('_solutionId'),'-', variables('_solutionVersion'))))]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnectorDefinition1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "displayName": "cveBuster Vulnerability Scanner",
        "contentKind": "DataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
              "apiVersion": "2022-09-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
              "location": "[parameters('workspace-location')]",
              "kind": "Customizable",
              "properties": {
                "connectorUiConfig": {
                  "id": "cveBusterVulnerabilitiesConnector",
                  "title": "cveBuster Vulnerability Scanner",
                  "publisher": "cveBuster",
                  "descriptionMarkdown": "The cveBuster data connector provides automated ingestion of vulnerability scan data from your cveBuster API into Microsoft Sentinel. This connector uses the Codeless Connector Framework (CCF) with REST API polling to continuously fetch vulnerability information including CVE details, CVSS scores, patch availability, exploit intelligence, and asset criticality. Data is ingested into a custom Log Analytics table for analysis, alerting, and visualization.",
                  "graphQueriesTableName": "cveBusterVulnerabilities_CL",
                  "graphQueries": [
                    {
                      "metricName": "Total vulnerability records",
                      "legend": "cveBuster Vulnerabilities",
                      "baseQuery": "{{graphQueriesTableName}}"
                    }
                  ],
                  "sampleQueries": [
                    {
                      "description": "All vulnerability records",
                      "query": "{{graphQueriesTableName}}\n| take 10"
                    },
                    {
                      "description": "Critical vulnerabilities with active exploits",
                      "query": "{{graphQueriesTableName}}\n| where Severity == 'Critical' and ExploitAvailable == true\n| project TimeGenerated, MachineName, VulnId, VulnTitle, CVSS, ExploitedInWild"
                    },
                    {
                      "description": "Vulnerability count by severity",
                      "query": "{{graphQueriesTableName}}\n| summarize Count=count() by Severity\n| render piechart"
                    }
                  ],
                  "dataTypes": [
                    {
                      "name": "{{graphQueriesTableName}}",
                      "lastDataReceivedQuery": "{{graphQueriesTableName}}\n| summarize Time = max(TimeGenerated)\n| where isnotempty(Time)"
                    }
                  ],
                  "connectivityCriteria": [
                    {
                      "type": "HasDataConnectors",
                      "value": null
                    }
                  ],
                  "availability": {
                    "status": 1,
                    "isPreview": false
                  },
                  "permissions": {
                    "resourceProvider": [
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces",
                        "permissionsDisplayText": "Read and Write permissions are required.",
                        "providerDisplayName": "Workspace",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "write": true,
                          "read": true,
                          "delete": true
                        }
                      },
                      {
                        "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                        "permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                        "providerDisplayName": "Keys",
                        "scope": "Workspace",
                        "requiredPermissions": {
                          "action": true
                        }
                      }
                    ],
                    "customs": [
                      {
                        "name": "cveBuster API Access",
                        "description": "An API key with read access to the cveBuster vulnerability scanning API is required."
                      }
                    ]
                  },
                  "instructionSteps": [
                    {
                      "title": "Configure Connection",
                      "description": "Enter your cveBuster API endpoint and authentication key. The connector will poll the API every 5 minutes.",
                      "instructions": [
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "API Endpoint URL",
                            "placeholder": "http://20.84.144.179:5000/api/vulnerabilities",
                            "name": "apiEndpoint"
                          }
                        },
                        {
                          "type": "Textbox",
                          "parameters": {
                            "label": "API Key",
                            "placeholder": "Enter your API key",
                            "name": "apiKey"
                          }
                        },
                        {
                          "type": "ConnectionToggleButton",
                          "parameters": {}
                        }
                      ]
                    }
                  ]
                }
              }
            },
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
                "kind": "DataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "cveBuster",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Your Company Support",
                  "email": "support@yourcompany.com",
                  "tier": "Partner",
                  "link": "https://yourcompany.com/support"
                },
                "dependencies": {
                  "criteria": [
                    {
                      "version": "[variables('dataConnectorCCPVersion')]",
                      "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                      "kind": "ResourcesDataConnector"
                    }
                  ]
                }
              }
            },
            {
              "name": "cveBusterVulnerabilitiesDCR",
              "apiVersion": "2022-06-01",
              "type": "Microsoft.Insights/dataCollectionRules",
              "location": "[parameters('workspace-location')]",
              "kind": "[variables('blanks')]",
              "properties": {
                "dataCollectionEndpointId": "[variables('dataCollectionEndpointId1')]",
                "streamDeclarations": {
                  "Custom-cveBusterVulnerabilitiesStream": {
                    "columns": [
                      {
                        "name": "MachineName",
                        "type": "string"
                      },
                      {
                        "name": "HostId",
                        "type": "string"
                      },
                      {
                        "name": "IPAddress",
                        "type": "string"
                      },
                      {
                        "name": "OSFamily",
                        "type": "string"
                      },
                      {
                        "name": "Application",
                        "type": "string"
                      },
                      {
                        "name": "AppFilePath",
                        "type": "string"
                      },
                      {
                        "name": "VulnId",
                        "type": "string"
                      },
                      {
                        "name": "VulnTitle",
                        "type": "string"
                      },
                      {
                        "name": "Severity",
                        "type": "string"
                      },
                      {
                        "name": "CVSS",
                        "type": "real"
                      },
                      {
                        "name": "ExploitAvailable",
                        "type": "boolean"
                      },
                      {
                        "name": "ExploitedInWild",
                        "type": "boolean"
                      },
                      {
                        "name": "PatchAvailable",
                        "type": "boolean"
                      },
                      {
                        "name": "FirstSeen",
                        "type": "datetime"
                      },
                      {
                        "name": "LastSeen",
                        "type": "datetime"
                      },
                      {
                        "name": "LastScanTime",
                        "type": "datetime"
                      },
                      {
                        "name": "AssetCriticality",
                        "type": "string"
                      },
                      {
                        "name": "BusinessOwner",
                        "type": "string"
                      },
                      {
                        "name": "Source",
                        "type": "string"
                      }
                    ]
                  }
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[variables('workspaceResourceId')]",
                      "name": "clv2ws1"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Custom-cveBusterVulnerabilitiesStream"
                    ],
                    "destinations": [
                      "clv2ws1"
                    ],
                    "transformKql": "source | extend TimeGenerated = now()",
                    "outputStream": "Custom-cveBusterVulnerabilities_CL"
                  }
                ]
              }
            },
            {
              "name": "cveBusterVulnerabilities_CL",
              "apiVersion": "2022-10-01",
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "location": "[parameters('workspace-location')]",
              "kind": null,
              "properties": {
                "schema": {
                  "name": "cveBusterVulnerabilities_CL",
                  "tableType": "CustomLog",
                  "description": "cveBuster vulnerability scan data containing CVE details, asset information, patch status, and exploit intelligence",
                  "columns": [
                    {
                      "name": "TimeGenerated",
                      "type": "datetime",
                      "isDefaultDisplay": true,
                      "description": "The timestamp when the data was ingested into Sentinel"
                    },
                    {
                      "name": "MachineName",
                      "type": "string",
                      "isDefaultDisplay": true,
                      "description": "Hostname of the scanned machine"
                    },
                    {
                      "name": "HostId",
                      "type": "string",
                      "description": "Unique identifier for the host (GUID format)"
                    },
                    {
                      "name": "IPAddress",
                      "type": "string",
                      "description": "IP address of the scanned machine"
                    },
                    {
                      "name": "OSFamily",
                      "type": "string",
                      "description": "Operating system family (Windows/Linux/macOS)"
                    },
                    {
                      "name": "Application",
                      "type": "string",
                      "isDefaultDisplay": true,
                      "description": "Name of the vulnerable application"
                    },
                    {
                      "name": "AppFilePath",
                      "type": "string",
                      "description": "File path of the vulnerable application"
                    },
                    {
                      "name": "VulnId",
                      "type": "string",
                      "isDefaultDisplay": true,
                      "description": "CVE identifier (e.g., CVE-2024-1234)"
                    },
                    {
                      "name": "VulnTitle",
                      "type": "string",
                      "isDefaultDisplay": true,
                      "description": "Vulnerability title/description"
                    },
                    {
                      "name": "Severity",
                      "type": "string",
                      "isDefaultDisplay": true,
                      "description": "Vulnerability severity level (Critical/High/Medium/Low)"
                    },
                    {
                      "name": "CVSS",
                      "type": "real",
                      "isDefaultDisplay": true,
                      "description": "CVSS score (0.0-10.0)"
                    },
                    {
                      "name": "ExploitAvailable",
                      "type": "boolean",
                      "description": "Whether a public exploit is available for this vulnerability"
                    },
                    {
                      "name": "ExploitedInWild",
                      "type": "boolean",
                      "description": "Whether active exploitation has been detected"
                    },
                    {
                      "name": "PatchAvailable",
                      "type": "boolean",
                      "description": "Whether a patch is available from the vendor"
                    },
                    {
                      "name": "FirstSeen",
                      "type": "datetime",
                      "description": "First time this vulnerability was detected on the asset"
                    },
                    {
                      "name": "LastSeen",
                      "type": "datetime",
                      "description": "Last time this vulnerability was detected"
                    },
                    {
                      "name": "LastScanTime",
                      "type": "datetime",
                      "description": "Most recent scan timestamp for this asset"
                    },
                    {
                      "name": "AssetCriticality",
                      "type": "string",
                      "description": "Business criticality of the asset (Critical/High/Medium/Low)"
                    },
                    {
                      "name": "BusinessOwner",
                      "type": "string",
                      "description": "Team or department responsible for the asset"
                    },
                    {
                      "name": "Source",
                      "type": "string",
                      "description": "Data source identifier (always 'cveBuster')"
                    }
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','dc','-', uniqueString(concat(variables('_solutionId'),'-','DataConnector','-',variables('_dataConnectorContentIdConnectorDefinition1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',variables('_dataConnectorContentIdConnectorDefinition1'))]",
      "apiVersion": "2022-09-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectorDefinitions",
      "location": "[parameters('workspace-location')]",
      "kind": "Customizable",
      "properties": {
        "connectorUiConfig": {
          "id": "cveBusterVulnerabilitiesConnector",
          "title": "cveBuster Vulnerability Scanner",
          "publisher": "cveBuster",
          "descriptionMarkdown": "The cveBuster data connector provides automated ingestion of vulnerability scan data from your cveBuster API into Microsoft Sentinel. This connector uses the Codeless Connector Framework (CCF) with REST API polling to continuously fetch vulnerability information including CVE details, CVSS scores, patch availability, exploit intelligence, and asset criticality. Data is ingested into a custom Log Analytics table for analysis, alerting, and visualization.",
          "graphQueriesTableName": "cveBusterVulnerabilities_CL",
          "graphQueries": [
            {
              "metricName": "Total vulnerability records",
              "legend": "cveBuster Vulnerabilities",
              "baseQuery": "{{graphQueriesTableName}}"
            }
          ],
          "sampleQueries": [
            {
              "description": "All vulnerability records",
              "query": "{{graphQueriesTableName}}\n| take 10"
            },
            {
              "description": "Critical vulnerabilities with active exploits",
              "query": "{{graphQueriesTableName}}\n| where Severity == 'Critical' and ExploitAvailable == true\n| project TimeGenerated, MachineName, VulnId, VulnTitle, CVSS, ExploitedInWild"
            },
            {
              "description": "Vulnerability count by severity",
              "query": "{{graphQueriesTableName}}\n| summarize Count=count() by Severity\n| render piechart"
            }
          ],
          "dataTypes": [
            {
              "name": "{{graphQueriesTableName}}",
              "lastDataReceivedQuery": "{{graphQueriesTableName}}\n| summarize Time = max(TimeGenerated)\n| where isnotempty(Time)"
            }
          ],
          "connectivityCriteria": [
            {
              "type": "HasDataConnectors",
              "value": null
            }
          ],
          "availability": {
            "status": 1,
            "isPreview": false
          },
          "permissions": {
            "resourceProvider": [
              {
                "provider": "Microsoft.OperationalInsights/workspaces",
                "permissionsDisplayText": "Read and Write permissions are required.",
                "providerDisplayName": "Workspace",
                "scope": "Workspace",
                "requiredPermissions": {
                  "write": true,
                  "read": true,
                  "delete": true
                }
              },
              {
                "provider": "Microsoft.OperationalInsights/workspaces/sharedKeys",
                "permissionsDisplayText": "Read permissions to shared keys for the workspace are required. [See the documentation to learn more about workspace keys](https://docs.microsoft.com/azure/azure-monitor/platform/agent-windows#obtain-workspace-id-and-key).",
                "providerDisplayName": "Keys",
                "scope": "Workspace",
                "requiredPermissions": {
                  "action": true
                }
              }
            ],
            "customs": [
              {
                "name": "cveBuster API Access",
                "description": "An API key with read access to the cveBuster vulnerability scanning API is required."
              }
            ]
          },
          "instructionSteps": [
            {
              "title": "Configure Connection",
              "description": "Enter your cveBuster API endpoint and authentication key. The connector will poll the API every 5 minutes.",
              "instructions": [
                {
                  "type": "Textbox",
                  "parameters": {
                    "label": "API Endpoint URL",
                    "placeholder": "http://20.84.144.179:5000/api/vulnerabilities",
                    "name": "apiEndpoint"
                  }
                },
                {
                  "type": "Textbox",
                  "parameters": {
                    "label": "API Key",
                    "placeholder": "Enter your API key",
                    "name": "apiKey"
                  }
                },
                {
                  "type": "ConnectionToggleButton",
                  "parameters": {}
                }
              ]
            }
          ]
        }
      }
    },
    {
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnectorDefinition1')))]",
      "apiVersion": "2022-01-01-preview",
      "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
      "properties": {
        "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectorDefinitions', variables('_dataConnectorContentIdConnectorDefinition1'))]",
        "contentId": "[variables('_dataConnectorContentIdConnectorDefinition1')]",
        "kind": "DataConnector",
        "version": "[variables('dataConnectorCCPVersion')]",
        "source": {
          "sourceId": "[variables('_solutionId')]",
          "name": "[variables('_solutionName')]",
          "kind": "Solution"
        },
        "author": {
          "name": "cveBuster",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Your Company Support",
          "email": "support@yourcompany.com",
          "tier": "Partner",
          "link": "https://yourcompany.com/support"
        },
        "dependencies": {
          "criteria": [
            {
              "version": "[variables('dataConnectorCCPVersion')]",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "kind": "ResourcesDataConnector"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentTemplates",
      "apiVersion": "2023-04-01-preview",
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('dataConnectorTemplateNameConnections1'), variables('dataConnectorCCPVersion'))]",
      "location": "[parameters('workspace-location')]",
      "dependsOn": [
        "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/contentPackages', variables('_solutionId'))]"
      ],
      "properties": {
        "contentId": "[variables('_dataConnectorContentIdConnections1')]",
        "displayName": "cveBuster Vulnerability Scanner",
        "contentKind": "ResourcesDataConnector",
        "mainTemplate": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "[variables('dataConnectorCCPVersion')]",
          "parameters": {
            "guidValue": {
              "defaultValue": "[[newGuid()]",
              "type": "securestring"
            },
            "innerWorkspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "connectorDefinitionName": {
              "defaultValue": "cveBuster Vulnerability Scanner",
              "type": "securestring",
              "minLength": 1
            },
            "workspace": {
              "defaultValue": "[parameters('workspace')]",
              "type": "securestring"
            },
            "dcrConfig": {
              "defaultValue": {
                "dataCollectionEndpoint": "data collection Endpoint",
                "dataCollectionRuleImmutableId": "data collection rule immutableId"
              },
              "type": "object"
            },
            "apiEndpoint": {
              "defaultValue": "apiEndpoint",
              "type": "securestring",
              "minLength": 1
            },
            "apiKey": {
              "defaultValue": "apiKey",
              "type": "securestring",
              "minLength": 1
            }
          },
          "variables": {
            "_dataConnectorContentIdConnections1": "[variables('_dataConnectorContentIdConnections1')]"
          },
          "resources": [
            {
              "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/',concat('DataConnector-', variables('_dataConnectorContentIdConnections1')))]",
              "apiVersion": "2022-01-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/metadata",
              "properties": {
                "parentId": "[extensionResourceId(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspace')), 'Microsoft.SecurityInsights/dataConnectors', variables('_dataConnectorContentIdConnections1'))]",
                "contentId": "[variables('_dataConnectorContentIdConnections1')]",
                "kind": "ResourcesDataConnector",
                "version": "[variables('dataConnectorCCPVersion')]",
                "source": {
                  "sourceId": "[variables('_solutionId')]",
                  "name": "[variables('_solutionName')]",
                  "kind": "Solution"
                },
                "author": {
                  "name": "cveBuster",
                  "email": "[variables('_email')]"
                },
                "support": {
                  "name": "Your Company Support",
                  "email": "support@yourcompany.com",
                  "tier": "Partner",
                  "link": "https://yourcompany.com/support"
                }
              }
            },
            {
              "name": "[[concat(parameters('innerWorkspace'),'/Microsoft.SecurityInsights/', 'cveBusterVulnerabilitiesPoller', parameters('guidValue'))]",
              "apiVersion": "2023-02-01-preview",
              "type": "Microsoft.OperationalInsights/workspaces/providers/dataConnectors",
              "location": "[parameters('workspace-location')]",
              "kind": "RestApiPoller",
              "properties": {
                "connectorDefinitionName": "cveBusterVulnerabilitiesConnector",
                "dcrConfig": {
                  "streamName": "Custom-cveBusterVulnerabilitiesStream",
                  "dataCollectionEndpoint": "[[parameters('dcrConfig').dataCollectionEndpoint]",
                  "dataCollectionRuleImmutableId": "[[parameters('dcrConfig').dataCollectionRuleImmutableId]"
                },
                "dataType": "cveBuster Vulnerabilities",
                "auth": {
                  "type": "APIKey",
                  "ApiKey": "[[parameters('apiKey')]",
                  "ApiKeyName": "Authorization"
                },
                "request": {
                  "apiEndpoint": "[[parameters('apiEndpoint')]",
                  "rateLimitQPS": 10,
                  "queryWindowInMin": 5,
                  "httpMethod": "GET",
                  "queryTimeFormat": "yyyy-MM-ddTHH:mm:ssZ",
                  "startTimeAttributeName": "createdAt__gt",
                  "endTimeAttributeName": "createdAt__lt",
                  "retryCount": 3,
                  "timeoutInSeconds": 60,
                  "headers": {
                    "Accept": "application/json",
                    "User-Agent": "cveBuster"
                  }
                },
                "paging": {
                  "pagingType": "NextPageToken",
                  "nextPageTokenJsonPath": "$.next_token",
                  "NextPageParaName": "next_token",
                  "PageSize": "50",
                  "PageSizeParameterName": "page_size"
                },
                "response": {
                  "eventsJsonPaths": [
                    "$.data"
                  ]
                }
              }
            }
          ]
        },
        "packageKind": "Solution",
        "packageVersion": "[variables('_solutionVersion')]",
        "packageName": "[variables('_solutionName')]",
        "contentProductId": "[concat(take(variables('_solutionId'), 50),'-','rdc','-', uniqueString(concat(variables('_solutionId'),'-','ResourcesDataConnector','-',variables('_dataConnectorContentIdConnections1'),'-', variables('dataConnectorCCPVersion'))))]",
        "packageId": "[variables('_solutionId')]",
        "contentSchemaVersion": "3.0.0",
        "version": "[variables('dataConnectorCCPVersion')]"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/providers/contentPackages",
      "apiVersion": "2023-04-01-preview",
      "location": "[parameters('workspace-location')]",
      "properties": {
        "version": "3.0.0",
        "kind": "Solution",
        "contentSchemaVersion": "3.0.0",
        "displayName": "cveBuster Vulnerability Scanning",
        "publisherDisplayName": "Your Company Support",
        "descriptionHtml": "<p><strong>Note:</strong> Please refer to the following before installing the solution:</p>\n<p>• Review the solution <a href=\"https://github.com/Azure/Azure-Sentinel/tree/master/Solutions/cveBuster%20Vulnerability%20Scanning/ReleaseNotes.md\">Release Notes</a></p>\n<p>• There may be <a href=\"https://aka.ms/sentinelsolutionsknownissues\">known issues</a> pertaining to this Solution, please refer to them before installing.</p>\n<p>The cveBuster Vulnerability Scanning solution provides automated vulnerability data ingestion from your cveBuster API into Microsoft Sentinel using the Codeless Connector Framework (CCF). This connector polls your vulnerability scanner API with automatic pagination handling and ingests comprehensive vulnerability scan data including CVE details, asset information, patch availability, and exploit intelligence.</p>\n<p><strong>Data Connectors:</strong> 1</p>\n<p><a href=\"https://aka.ms/azuresentinel\">Learn more about Microsoft Sentinel</a> | <a href=\"https://aka.ms/azuresentinelsolutionsdoc\">Learn more about Solutions</a></p>\n",
        "contentKind": "Solution",
        "contentProductId": "[variables('_solutioncontentProductId')]",
        "id": "[variables('_solutioncontentProductId')]",
        "icon": "<svg>...</svg>",
        "contentId": "[variables('_solutionId')]",
        "parentId": "[variables('_solutionId')]",
        "source": {
          "kind": "Solution",
          "name": "cveBuster Vulnerability Scanning",
          "sourceId": "[variables('_solutionId')]"
        },
        "author": {
          "name": "cveBuster",
          "email": "[variables('_email')]"
        },
        "support": {
          "name": "Your Company Support",
          "email": "support@yourcompany.com",
          "tier": "Partner",
          "link": "https://yourcompany.com/support"
        },
        "dependencies": {
          "operator": "AND",
          "criteria": [
            {
              "kind": "DataConnector",
              "contentId": "[variables('_dataConnectorContentIdConnections1')]",
              "version": "[variables('dataConnectorCCPVersion')]"
            }
          ]
        },
        "firstPublishDate": "2025-11-02",
        "lastPublishDate": "2025-11-02",
        "providers": [
          "Your Company"
        ],
        "categories": {
          "domains": [
            "Security - Vulnerability Management",
            "Security - Threat Protection"
          ]
        }
      },
      "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/', variables('_solutionId'))]"
    }
  ],
  "outputs": {}
}
