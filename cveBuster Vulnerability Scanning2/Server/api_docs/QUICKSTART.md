# cveBuster - Complete VM Setup Guide

## One-Command Setup (Recommended)

This script automates the entire process from a bare Ubuntu/Debian VM to a fully functional cveBuster API with documentation.

### Prerequisites
- Ubuntu 18.04+ or Debian 10+
- SSH access with root/sudo privileges
- Internet connection

### Step 1: Download the Setup Script

Option A: Clone from your Azure-Sentinel repo
```bash
git clone https://github.com/Azure/Azure-Sentinel.git
cd Azure-Sentinel/Solutions/"cveBuster Vulnerability Scanning"/Server/api_docs
```

Option B: Download directly
```bash
curl -O https://raw.githubusercontent.com/your-repo/api_docs/server.sh
chmod +x server.sh
```

### Step 2: Run the Setup

**Full Setup (Recommended)**
```bash
cd /path/to/setup
sudo bash server.sh full
```

This will:
- ✅ Update system packages
- ✅ Install Python 3, git, and dependencies
- ✅ Clone the cveBuster repository
- ✅ Create Python virtual environment
- ✅ Install Flask and dependencies
- ✅ Generate sample vulnerability data
- ✅ Configure API service (systemd)
- ✅ Configure documentation service (systemd)
- ✅ Start both services automatically

**Development Mode** (no services started)
```bash
sudo bash server.sh dev
```

**Documentation Only** (if API already exists)
```bash
sudo bash server.sh docs-only
```

### Step 3: Access Your Services

After setup completes, you'll see a summary with:

**API Access:**
```
http://your-server-ip:5000/api/vulnerabilities
```

**Documentation:**
```
http://your-server-ip:80
```

**Test with curl:**
```bash
# Get vulnerabilities (requires API key)
curl -H "Authorization: cvebuster-demo-key-12345" \
  http://localhost:5000/api/vulnerabilities

# View documentation
curl http://localhost/
```

---

## Service Management

The setup creates two systemd services that start automatically on boot.

### API Service (Flask Application)

```bash
# Start/stop/restart
sudo systemctl start cvebuster-api
sudo systemctl stop cvebuster-api
sudo systemctl restart cvebuster-api

# Check status
sudo systemctl status cvebuster-api

# View logs
sudo journalctl -u cvebuster-api -f

# Enable/disable on boot
sudo systemctl enable cvebuster-api
sudo systemctl disable cvebuster-api
```

### Documentation Service

```bash
# Start/stop/restart
sudo systemctl start cvebuster-docs
sudo systemctl stop cvebuster-docs
sudo systemctl restart cvebuster-docs

# Check status
sudo systemctl status cvebuster-docs

# View logs
sudo journalctl -u cvebuster-docs -f

# Enable/disable on boot
sudo systemctl enable cvebuster-docs
sudo systemctl disable cvebuster-docs
```

### View All Logs

```bash
# Combined logs from both services
sudo journalctl -f

# Logs from last hour
sudo journalctl --since "1 hour ago"

# Logs from specific time
sudo journalctl --since "2024-01-15 10:00:00"
```

---

## Directory Structure After Setup

```
/root/
├── cveBuster Vulnerability Scanning/
│   └── Server/
│       ├── app_paginated.py           # Flask API application
│       ├── cvebuster_data.json        # Vulnerability database
│       ├── venv/                      # Python virtual environment
│       ├── requirements.txt           # Python dependencies
│       └── api_docs/                  # Documentation files
│           ├── index.html             # API documentation webpage
│           ├── server_linux.py        # Docs server script
│           └── server.sh              # This setup script
```

---

## Configuration

### Change API Port

Edit the systemd service:
```bash
sudo nano /etc/systemd/system/cvebuster-api.service

# Change the port in app_paginated.py or set environment variable
# Then reload:
sudo systemctl daemon-reload
sudo systemctl restart cvebuster-api
```

### Change Documentation Port

```bash
# Edit the service file
sudo nano /etc/systemd/system/cvebuster-docs.service

# Modify the PORT environment variable:
# Environment="PORT=8080"

# Reload and restart
sudo systemctl daemon-reload
sudo systemctl restart cvebuster-docs
```

### Change API Key

Edit the API file:
```bash
# Edit the Flask app
sudo nano /root/cveBuster\ Vulnerability\ Scanning/Server/app_paginated.py

# Find: API_KEY = "cvebuster-demo-key-12345"
# Change to your own key

# Also update documentation
sudo nano /root/cveBuster\ Vulnerability\ Scanning/Server/api_docs/index.html
# Search and replace the API key

# Restart API
sudo systemctl restart cvebuster-api
```

### Update Vulnerability Data

```bash
# The data file is at:
/root/cveBuster\ Vulnerability\ Scanning/Server/cvebuster_data.json

# Edit it:
sudo nano /root/cveBuster\ Vulnerability\ Scanning/Server/cvebuster_data.json

# No restart needed - API reloads on each request
```

---

## Troubleshooting

### Issue: "Permission denied" on port 80

**Solution:** The script runs as root automatically, but check:
```bash
sudo lsof -i :80      # Check what's on port 80
sudo lsof -i :5000    # Check what's on port 5000
```

### Issue: Services not starting

**Check logs:**
```bash
sudo journalctl -u cvebuster-api -n 50
sudo journalctl -u cvebuster-docs -n 50
```

**Common causes:**
- Port already in use
- Python not installed correctly
- File permissions issue

### Issue: Cannot access documentation

**Check if service is running:**
```bash
sudo systemctl status cvebuster-docs
```

**Try accessing locally first:**
```bash
curl http://localhost
curl http://localhost:80
```

**Check firewall:**
```bash
sudo ufw status
sudo ufw allow 80/tcp
sudo ufw allow 5000/tcp
```

### Issue: API returns 401 Unauthorized

**Check your API key:**
- Default key: `cvebuster-demo-key-12345`
- Must match in both API code and requests

**Test with correct key:**
```bash
curl -H "Authorization: cvebuster-demo-key-12345" \
  http://localhost:5000/api/vulnerabilities
```

---

## Running Multiple Instances

To run multiple copies on different ports:

```bash
# Create new directory
mkdir /opt/cvebuster-instance2
cd /opt/cvebuster-instance2

# Download script
curl -O https://raw.githubusercontent.com/your-repo/api_docs/server.sh

# Set environment variables and run
export INSTALL_DIR="/opt/cvebuster-instance2"
export API_PORT=5001
export PORT=8080

sudo bash server.sh full
```

---

## Upgrading/Reinstalling

### Update to latest code

```bash
cd /root/cveBuster\ Vulnerability\ Scanning/Server
git pull origin main
source venv/bin/activate
pip install -r requirements.txt
sudo systemctl restart cvebuster-api
```

### Reinstall from scratch

```bash
# Stop services
sudo systemctl stop cvebuster-api cvebuster-docs

# Remove old installation
sudo rm -rf /root/cveBuster\ Vulnerability\ Scanning/

# Run setup again
sudo bash server.sh full
```

---

## Uninstall

To remove everything:

```bash
# Stop services
sudo systemctl stop cvebuster-api cvebuster-docs

# Disable services
sudo systemctl disable cvebuster-api cvebuster-docs

# Remove service files
sudo rm /etc/systemd/system/cvebuster-api.service
sudo rm /etc/systemd/system/cvebuster-docs.service

# Reload systemd
sudo systemctl daemon-reload

# Remove installation directory
sudo rm -rf /root/cveBuster\ Vulnerability\ Scanning/
```

---

## Next Steps

1. ✅ Run setup script
2. ✅ Access API documentation at http://localhost
3. ✅ Test API with example requests
4. ✅ Integrate with your applications
5. ✅ Customize API key and data as needed

---

## Support

For issues:
1. Check logs: `sudo journalctl -u cvebuster-api -f`
2. Verify services: `systemctl status cvebuster-*`
3. Test connectivity: `curl -v http://localhost/`

**Script Location:** `/root/cveBuster Vulnerability Scanning/Server/api_docs/server.sh`

**System Services:** 
- `/etc/systemd/system/cvebuster-api.service`
- `/etc/systemd/system/cvebuster-docs.service`
